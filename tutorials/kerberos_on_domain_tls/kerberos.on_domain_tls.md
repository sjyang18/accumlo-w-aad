# Kerberos enabling on Domain-enabled and TLS-enabled Accumulo cluster (WIP)
Given you have enabled Domain and TLS in your Accumulo cluster (for example, in our previous tutorial, I employed Azure AAD Domain service for this purpose, and the tutorial is available in https://github.com/sjyang18/accumulo-w-aad/blob/main/tutorials/domain_plus_tls/domain.plus.tls.md), this time, we are going to add & modify kerberos-related configuration to the cluster. In general, this involves the two stages: 1) adding service principals and their keytab files to your selected domain/kerberos service, 2) adding & modifying hadoop and accumulo configuration for enabling kerberos with keytab files. Currently, we have multiple domain services & kerberos service products and different methodologies to setting up e& gnerating keytab files. To avoid the tightly-coupled solution, this tutorial will show one replacable first stage of generating keytab files that follows the same environment we created in the previous tutorial, and demonstrate the second stage deployment with the expected keytabs file name patterns. 

## Git clone this repo to get fluo-mucho addon ansible playbooks 
Inside the proxy/bastion node, run to get this repo. We used this repo in the previous tutorial to join accumulo cluster to Azure AAD domain service.

```
sudo yum install git
git clone https://github.com/sjyang18/accumulo-w-aad.git
```
You may copy out ~/ansible/conf/hosts generated by fluo-much to $HOME and add the requried variables to hosts file (The variables is mentioned in https://github.com/sjyang18/accumulo-w-aad/blob/main/tutorials/domain_plus_tls/domain.plus.tls.md#edit-ansible-inventory-file). This will save from losing these variables when you run 'mucho sync' command. Some of variables you may check again depending on your cluster are:
```
custom_ou_name=XXX              # custom organization unit where you want to add users
domain_admin_username=XXX       # one of username who is Azure AAD domain
```

## Service principal and keytab files
In order to enable kerberos in Accumulo cluster with fluo-mucho, we need to first generate service principals and keytab files for those. If you have followed our previous tutorial and joined your cluster to Azure AAD domain services, customers may run the following command to generate users, the corresponding service principals, and keytab files.

```
ansible-playbook -i hosts accumulo-w-aad/ansible/ldap_adduser.yml
```

Otherwise, we expect customers to generate those service principals and keytab files with the following convention.

```
HTTP.{{ hostname }}.keytab
{{ service_user_name }}.{{ hostname }}.keytab
```

For example, 'ldap_adduser.yml' would generate the following keytab files for our accucluster3 and fetch them to keytabs directory of bastion host.
```
[azureuser@bastion ~]$ tree keytabs/
keytabs/
├── azureuser.accucluster3-0.keytab
├── azureuser.accucluster3-1.keytab
├── azureuser.accucluster3-2.keytab
├── azureuser.accucluster3-3.keytab
├── azureuser.accucluster3-4.keytab
├── azureuser.accucluster3-5.keytab
├── azureuser.accucluster3-6.keytab
├── azureuser.accucluster3-8.keytab
├── HTTP.accucluster3-0.keytab
├── HTTP.accucluster3-1.keytab
├── HTTP.accucluster3-2.keytab
├── HTTP.accucluster3-3.keytab
├── HTTP.accucluster3-4.keytab
├── HTTP.accucluster3-5.keytab
├── HTTP.accucluster3-6.keytab
└── HTTP.accucluster3-8.keytab
```

By chance, if you see the following error, you might have to update the password of AAD DC Administrator user 'https://myaccount.microsoft.com/'. Log into the site with the user you choose for AAD DC Administrator user and update its password.

```
ldap_sasl_bind(SIMPLE): Can't contact LDAP server (-1)
```

